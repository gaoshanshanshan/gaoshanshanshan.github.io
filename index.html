<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>ç­¾åˆ°</title>
    <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/customParseFormat.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekday.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/localeData.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekOfYear.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekYear.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/advancedFormat.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/quarterOfYear.js"></script>
    <link
      type="text/css"
      href="https://unpkg.com/ant-design-vue@4.2.3/dist/reset.css"
      media="screen"
      rel="stylesheet"
    />
    <link
      type="text/css"
      href="https://unpkg.com/vue-json-pretty@2.4.0/lib/styles.css"
      media="screen"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/ant-design-vue@4.2.3/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue-json-pretty@2.4.0/lib/vue-json-pretty.js"></script>
    <script src="https://unpkg.com/vue-ls@4.2.0/dist/vue-ls.min.js"></script>
    <style>
      .vjs-tree {
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="container" style="padding: 8px 10px 0">
        <a-config-provider component-size="small">
          <h3 style="text-align: center; margin-top: 10px; height: 22px">
            <span> {{contextMap.theme}} </span>
          </h3>
          <div style="margin: 10px 0; text-align: right">
            <span>è°ƒè¯•æ¨¡å¼</span>
            <a-switch
              size="default"
              style="margin-left: 10px"
              v-model:checked="debugRef"
              checked-children="å¼€"
              un-checked-children="å…³"
            />
          </div>
          <a-tabs v-model:activeKey="activeKey">
            <a-tab-pane key="1" tab="æœ€æ–°ç­¾åˆ°">
              <a-button
                type="primary"
                @click="getNewSignInfo"
                :loading="newSignInfo.loading"
                style="margin-bottom: 10px; float: right"
              >
                åˆ·æ–°
              </a-button>
              <a-descriptions title="æœ€æ–°ç­¾åˆ°ä¿¡æ¯">
                <a-descriptions-item label="ç­¾åˆ°äºº"
                  >{{newSignInfo.name}}</a-descriptions-item
                >
                <a-descriptions-item label="éƒ¨é—¨"
                  >{{newSignInfo.dept}}</a-descriptions-item
                >
                <a-descriptions-item label="ç­¾åˆ°æ—¶é—´"
                  >{{newSignInfo.signTime}}</a-descriptions-item
                >
              </a-descriptions>
            </a-tab-pane>
            <a-tab-pane key="2" tab="å·²ç­¾åˆ°åˆ—è¡¨">
              <div style="display: flex; justify-content: space-between">
                <span>ç­¾åˆ°äººæ•°ï¼š{{signList.signList.length}}</span>
                <a-button
                  type="primary"
                  @click="getSignList"
                  :loading="signList.loading"
                  style="margin-bottom: 10px; float: right"
                >
                  åˆ·æ–°
                </a-button>
              </div>
              <a-table
                :columns="columns"
                :data-source="signList.signList"
                :scroll="{ y: 600 }"
                :pagination="false"
              >
              </a-table>
            </a-tab-pane>
            <a-tab-pane key="3" tab="æˆ‘çš„ç­¾åˆ°">
              <a-button type="primary" @click="submitData" style="float: right">
                ç­¾åˆ°
              </a-button>
              <div style="margin-top: 10px">
                <vue-json-pretty
                  editable
                  editableTrigger="dblclick"
                  v-model:data="submitState.data"
                  virtual
                  :height="350"
                ></vue-json-pretty>
              </div>
              <h3
                v-show="submitResult.id"
                style="text-align: center; margin-top: 60px"
              >
                ç­¾åˆ°ç»“æœ
              </h3>
              <div
                v-show="submitResult.id"
                style="margin-top: 10px; height: 300px"
              >
                <vue-json-pretty
                  :data="submitResult"
                  virtual
                  :height="350"
                ></vue-json-pretty>
              </div>
            </a-tab-pane>
          </a-tabs>

          <div style="margin-top: 20px"></div>
        </a-config-provider>
      </div>
    </div>

    <script>
      // æµ‹è¯•æ¨¡å¼
      const storage = VueStorage.useStorage("localStorage").ls;
      const debug = storage.get("modeDebug", true);
      const uuid = getUUID();
      const defaultData = {
        content: {
          name: debug ? "dfsfj" : "ç‹é«˜å±±",
          dept: debug ? "xxsdfjkl" : "ç ”å‘éƒ¨",
          signature: debug
            ? "https://ybpt-public.obs.cn-north-4.myhuaweicloud.com/a5212b6393234525444b38d4cee1d358/ykCust/be28a25044034baa838d4c3343d08bcd/%E7%AD%BE%E5%90%8D_b4b736ad69c5456a8919dabc2ee2b330.png"
            : "https://ybpt-public.obs.cn-north-4.myhuaweicloud.com/a5212b6393234525444b38d4cee1d358/ykCust/473db1f05b804751848db089a9bea588/ç­¾å_0a72caa304494e59bbd397bd1142c1ed.png",
          uuid,
          sign: `QD_`,
          queId: "",
          theme: "",
          ipAddress: "218.57.140.130, 124.70.126.44, 172.16.21.60",
          isWx: "æ˜¯",
          ua: "mozilla/5.0 (linux; android 11; redmi k60 build/rkq1.200826.002; wv) applewebkit/537.36 (khtml, like gecko) version/4.0 chrome/126.0.6478.122 mobile safari/537.36 xweb/1260053 mmwebsdk/20240501 mmwebid/959 micromessenger/8.0.50.2701(0x28003252) wechat/arm64 weixin nettype/wifi language/zh_cn abi/arm64 edg/126.0.0.0",
        },
        formDesignVersion: "",
        token: "",
        openId: "",
      };

      const personNameList = debug
        ? ["åŠ¨æ€äºŒç»´ç 1111"]
        : [
            "è†ä¹¦å…¸",
            "æå°‘æ•",
            "ç‹åº·æ¬¢",
            "æ¨å«ç¬‘",
            "æç‡•",
            "ä»»æ˜Šå®‡",
            "é‚¢å­ç’ ",
            "åˆ˜ä¹ ",
            "é«˜å…ˆæ³½",
            "ç‹å¸¸å",
            "ç½—å­¦è¿",
            "æå©·å©·",
            "äºå¦å‰",
            "ææµ·å·",
            "å¼ ä¼ æ¢…",
            "æå…‹ç§‹",
            "å¼ çŠçŠ",
            "äº“æ–°æ˜",
            "å¼ è·¯è·¯",
            "æ¢å†¬é›ª",
            "é©¬æµ·å³°",
            "ç”°æˆå¹³",
            "åˆ˜æ™“è¾‰",
            "å¼ åšè¯š",
            "é™ˆåº†è¾‰",
            "é©¬æ ‘æˆ",
            "é»„å…¶èŒ",
            "ç‹å»ºæ–‡",
            "å‘¨å¤§é¹",
            "åˆ˜ä¸­å¿—",
            "ç‹é«˜å±±",
            "åˆ˜æ–‡æ°",
            "é©¬æ°¸è¾‰",
            "è§£å½¬",
            "å¼ æµ·æ»¨",
            "è”¡æµ©ç„¶",
            "é™ˆé¹é£",
            "å´”æ©æ³‰",
            "æ–¹èŒ",
            "æè‡ªå¼º",
            "å´ä¼Ÿ",
            "å¼ äº®äº®",
            "ç‹å’",
            "æ²ˆåˆ©",
            "åˆ˜å¹¿é‘«",
            "å®‹åº†æ¾",
            "ç‹äº‘é£",
            "å¼ æ¶›",
            "ç‹ä¼Ÿå¼º",
            "éŸ©å†°",
            "åºæ˜¥ç§‹",
            "å¼ å›½æ—",
            "é«˜æœ‹",
            "å‰ç«¯å¼ æ¶›",
            "å¼ å›½æ ‹",
            "ç‹æµ·å·",
            "çŸ³ä¸°æº",
            "è‹é¹",
            "é©¬å‡¯æ´‹",
            "å®‰é¸¿æ•ˆ",
            "ç‹äºš",
            "åˆ˜æ°",
            "å…¬ä½©å®‡",
            "æé¸¿åŸº",
            "æœ±æ¸…å‡¡",
            "åˆ˜æ´è²",
            "ç¿Ÿç‰æ˜Ÿ",
          ];
      Object.assign(window, Vue);
      //è·å–uuid
      function getUUID() {
        var questionUuid = storage.get("questionUuid");
        if (questionUuid) {
          return questionUuid;
        } else {
          let questionUuid = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            function (c) {
              var r = (Math.random() * 16) | 0,
                v = c == "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
          storage.set("questionUuid", questionUuid);
          return questionUuid;
        }
      }

      const vue3Composition = {
        setup() {
          const debugRef = ref(debug);
          watch(
            () => debugRef.value,
            () => {
              storage.set("modeDebug", debugRef.value);
              window.location.reload();
            }
          );
          const activeKey = ref("3");

          // è·å–ç­¾åˆ°ä¿¡æ¯
          const contextMap = reactive({
            // æµ‹è¯•ç¯å¢ƒ
            debug,
            domain: debug
              ? "http://lctest.yibiao163.cn"
              : "https://dalu.yibiao163.cn",
            appCode: "TyQff7e3hi9Tw3k",
            moduleCode: "tGuHzGbamoytfYt",
            queCode: "",
            theme: "",
          });
          const submitState = reactive({
            val: JSON.stringify(defaultData),
            data: defaultData,
          });

          watch(
            () => submitState.val,
            (newVal) => {
              try {
                submitState.data = JSON.parse(newVal);
              } catch (err) {
                // console.log('JSON ERROR');
              }
            }
          );

          watch(
            () => submitState.data,
            (newVal) => {
              try {
                submitState.val = JSON.stringify(newVal);
              } catch (err) {
                // console.log('JSON ERROR');
              }
            }
          );

          function getQueInfo() {
            Promise.all([
              axios.get(
                `${contextMap.domain}/nai/lowcode/editor/v1/questionnaire/last/${contextMap.appCode}/${contextMap.moduleCode}`
              ),
              axios.get(
                `${contextMap.domain}/nai/lowcode/editor/v1/formDesign/code?moduleCode=${contextMap.moduleCode}&appCode=${contextMap.appCode}`
              ),
            ]).then(([queResp, designResp]) => {
              if (queResp.data && queResp.data.status == "0") {
                const data = queResp.data.data;
                contextMap.queCode = data.queCode;
                contextMap.theme = data.content.theme;
                submitState.data.content.queId = data.id;
                submitState.data.content.sign = `QD_${submitState.data.content.queId}_${submitState.data.content.uuid}`;
                submitState.data.content.theme = data.content.theme;
              }
              if (designResp.data && designResp.data.status == "0") {
                const data = designResp.data.data;
                submitState.data.formDesignVersion = data.version;
              }
            });
          }

          // è·å–æœ€æ–°ç­¾åˆ°ä¿¡æ¯
          const newSignInfo = reactive({
            loading: false,
            signTime: "",
            name: "",
            dept: "",
          });
          function getNewSignInfo() {
            newSignInfo.signTime = "";
            newSignInfo.name = "";
            newSignInfo.dept = "";
            newSignInfo.loading = true;
            axios
              .post(
                `${contextMap.domain}/nai/lowcode/editor/v1/questionnaire/bd/${contextMap.appCode}/${contextMap.moduleCode}/getLastDetailByFormField`,
                {
                  fieldCode: "theme",
                  fieldValue: debug ? personNameList[0] : contextMap.theme,
                }
              )
              .then((res) => {
                if (res.data && res.data.status == "0") {
                  if (res.data.data) {
                    const data = res.data.data;
                    const content = data.content;
                    newSignInfo.signTime = new Date(
                      data.createTime
                    ).toLocaleString();
                    newSignInfo.name = content.name;
                    newSignInfo.dept = content.dept;
                  } else {
                    this.$message.warn("æš‚æ— ç­¾åˆ°ä¿¡æ¯");
                  }
                }
              })
              .finally(() => {
                newSignInfo.loading = false;
              });
          }

          // è·å–ç­¾åˆ°åˆ—è¡¨
          const signList = reactive({
            loading: false,
            signList: [],
          });
          const columns = [
            {
              title: "ç­¾åˆ°äºº",
              dataIndex: "name",
              key: "name",
              customRender({ text, record, index, column }) {
                return Vue.h(
                  "span",
                  {
                    style: {
                      color: [
                        "è†ä¹¦å…¸",
                        "æå°‘æ•",
                        "ç‹åº·æ¬¢",
                        "é©¬æµ·å³°",
                        "åˆ˜ä¹ ",
                        "æ–¹èŒ",
                      ].includes(text)
                        ? "red"
                        : "rgba(0, 0, 0, 0.88)",
                    },
                  },
                  text
                );
              },
            },
            {
              title: "ç­¾åˆ°æ—¶é—´",
              dataIndex: "signTime",
              key: "signTime",
            },
          ];
          function getSignList() {
            signList.signList = [];
            signList.loading = true;
            const requestList = personNameList.map((name) => {
              return axios.post(
                `${contextMap.domain}/nai/lowcode/editor/v1/questionnaire/bd/${contextMap.appCode}/${contextMap.moduleCode}/getLastDetailByFormField`,
                {
                  fieldCode: debug ? "theme" : "name",
                  fieldValue: name,
                }
              );
            });

            Promise.all(requestList)
              .then((resList) => {
                resList.forEach((res) => {
                  if (res.data && res.data.status == "0" && res.data.data) {
                    const data = res.data.data;
                    const content = data.content;
                    if (debug || data.queCode === contextMap.queCode) {
                      signList.signList.push({
                        signTime: new Date(data.createTime).toLocaleString(),
                        name: content.name,
                        createTime: data.createTime,
                      });
                    }
                  }
                });
                signList.signList.sort(function (a, b) {
                  return b.createTime - a.createTime;
                });
              })
              .finally(() => {
                signList.loading = false;
              });
          }

          const submitResult = ref({ id: "" });
          const submitData = () => {
            antd.Modal.confirm({
              title: "æç¤º",
              content: "ç¡®å®šè¦æäº¤çš„ç­¾åˆ°ä¿¡æ¯",
              async onOk() {
                try {
                  return await axios
                    .post(
                      `${contextMap.domain}/nai/lowcode/editor/v1/questionnaire/bd/${contextMap.appCode}/${contextMap.moduleCode}/${contextMap.queCode}/submit`,
                      Vue.toValue(submitState.data)
                    )
                    .then((res) => {
                      if (res.data && res.data.status == "0") {
                        antd.message.success("ğŸ‰ğŸ‰ğŸ‰ æäº¤æˆåŠŸ");
                        fetchNewData();
                      } else {
                        antd.message.error("ğŸ’”ğŸ’”ğŸ’” æäº¤å¤±è´¥", res);
                      }
                    });
                } catch (e) {
                  return console.error("Oops errors!", e);
                }
              },
              onCancel() {},
            });
          };
          function fetchNewData() {
            axios
              .post(
                `${contextMap.domain}/nai/lowcode/editor/v1/questionnaire/bd/${contextMap.appCode}/${contextMap.moduleCode}/getLastDetailByFormField`,
                {
                  fieldCode: "name",
                  fieldValue: submitState.data.content.name,
                }
              )
              .then((res) => {
                if (res.data && res.data.status == "0") {
                  submitResult.value = res.data.data;
                } else {
                  antd.message.error("æ²¡æœ‰è·å–åˆ°æœ€æ–°ç­¾åˆ°æ•°æ®");
                }
              });
          }

          getQueInfo();

          return {
            debugRef,
            activeKey,
            contextMap,
            newSignInfo,
            getNewSignInfo,
            columns,
            signList,
            getSignList,
            submitState,
            submitData,
            submitResult,
          };
        },
      };

      //åˆå§‹åŒ–
      const app = createApp(vue3Composition);
      app.use(antd);
      app.use(VueStorage);
      app.component("VueJsonPretty", VueJsonPretty.default);
      app.mount("#app");
    </script>
  </body>
</html>
